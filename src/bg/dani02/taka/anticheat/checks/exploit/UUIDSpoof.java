package bg.dani02.taka.anticheat.checks.exploit;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URL;
import java.util.UUID;

import org.bukkit.event.player.AsyncPlayerPreLoginEvent;
import org.bukkit.event.player.AsyncPlayerPreLoginEvent.Result;

import com.google.common.base.Charsets;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;

import bg.dani02.taka.anticheat.Utils;
import bg.dani02.taka.anticheat.enums.HackType;

public class UUIDSpoof {
	public static void onJoin(AsyncPlayerPreLoginEvent e) {
		if(!Utils.checkModule(Utils.getCheatPlayer(e.getUniqueId()), HackType.EXPLOIT_UUID_SPOOF))
			return;
		if (!fastLoginFetcher(e.getName(), e.getUniqueId().toString())) {
			e.setKickMessage(Utils.prepareColors(Utils.getTakaPrefix() + " Please turn off UUIDSpoof!"));
			e.setLoginResult(Result.KICK_OTHER);
		}
	}

	private static String fetchUUID(String username, boolean onlineMode) {
		if (onlineMode) {
			try {
				URL url = new URL("https://api.mojang.com/users/profiles/minecraft/" + username);
				InputStream stream = url.openStream();
				InputStreamReader inr = new InputStreamReader(stream);
				BufferedReader reader = new BufferedReader(inr);
				String s;
				StringBuilder sb = new StringBuilder();

				while ((s = reader.readLine()) != null)
					sb.append(s);

				String result = sb.toString();

				JsonElement element = new JsonParser().parse(result);
				JsonObject obj = element.getAsJsonObject();

				String uuid = obj.get("id").toString();

				uuid = uuid.substring(1);
				uuid = uuid.substring(0, uuid.length() - 1);

				return uuid;
			} catch (Exception ex) {
			}
		} else {
			return UUID.nameUUIDFromBytes(("OfflinePlayer:" + username).getBytes(Charsets.UTF_8)).toString();
		}

		return null;
	}

	private static boolean fastLoginFetcher(String name, String uuid) {
		if (fetchUUID(name, true).equals(uuid) || fetchUUID(name, false).equals(uuid)) {
			return true;
		}

		return false;
	}

}